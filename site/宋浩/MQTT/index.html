<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>MQTT - 查阅手册</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "MQTT";
        var mkdocs_page_input_path = "\u5b8b\u6d69\\MQTT.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 查阅手册
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome to MkDocs</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">宋浩</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">MQTT</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#1mq">1.M&amp;Q</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2mqtt">2.MQTT</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#active-mq">Active MQ</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#zeno-mq">Zeno MQ</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#mqtt_1">MQTT</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3mqtt">3.MQTT模型</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4python-mqtt">4.python MQTT使用</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#6">6 源码解析</a>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">查阅手册</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>宋浩 &raquo;</li>
      <li>MQTT</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="mqtt">MQTT</h2>
<h4 id="1mq">1.M&amp;Q</h4>
<p>​   M = 消息</p>
<p>​   Q = 队列</p>
<h4 id="2mqtt">2.MQTT</h4>
<h6 id="active-mq">Active MQ</h6>
<p>​   Active MQ = 一个消息队列应用服务器（推送服务器）</p>
<p><img alt="" src="https://pic2.zhimg.com/v2-dd5579d4e545784c852d08903416a02d_r.jpg" /></p>
<pre><code>Producer：消息生产者，负责产生和发送消息到 Broker；   

Broker：消息处理中心。负责消息存储、确认、重试等，一般其中会包含多个 queue；

Consumer：消息消费者，负责从 Broker 中获取消息，并进行相应处理；
</code></pre>
<pre><code class="language-python">ActiveMQ能做什么
    1.实现两个不同应用之间的通讯
    2.实现同一个应用，不同模块之间的消息通讯

ActiveMQ特点
    1.支持多语言（Java,C,C++,C#,Ruby,Perl,Python,PHP）多协议客户端（OpenWire, Stomp REST, WS Notification, XMPP, AMQP）
    2.对Spring的支持，ActiveMQ可以很容易整合到Spring的系统里面去。
    3.支持高可用、高性能的集群模式。
</code></pre>
<h5 id="zeno-mq">Zeno MQ</h5>
<pre><code class="language-python">ZMQ简介：ZMQ看起来像是一个嵌入式网络连接库，但实际上是一个并发框架。框架提供的套接字可以满足在多种协议之间传输原子信息，如线程间、进程间、TCP、广播等。可以使用ZMQ构建多对多的连接方式，如扇出、发布-订阅、任务分发、请求-应答等。ZMQ的高速使得它能胜任分布式应用。它的异步I/O机制让你能够构建多核应用程序，完成异步消息处理任务。ZMQ有着多语言支持，并能在几乎所有的操作系统上运行。
</code></pre>
<p>​   三种基本模型</p>
<p>​   Request-Reply（请求-回复）请求应答模式</p>
<p>​   客户端发起请求，并等待服务端回应请求。客户端发送一个简单的 “Hello”，服务端则回应一个 “World”。可以有 N 个客户端，一个服务端，因此是 1-N 连接。</p>
<p>​   <img alt="" src="https://upload-images.jianshu.io/upload_images/1752522-bdc5fcaa6a2fa8c5.png?imageMogr2/auto-orient/strip|imageView2/2/w/234/format/webp" /></p>
<p>​   Publish-Subscribe 发布-订阅模式</p>
<p>​   一个天气预报的例子来介绍该模式。服务端不断地更新各个城市的天气，客户端可以订阅自己感兴趣（通过一个过滤器）的城市的天气信息。</p>
<p>​   <img alt="" src="https://upload-images.jianshu.io/upload_images/1752522-3faf1defd6c84b82.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp" /></p>
<p>​   Parallel Pipeline 分布式处理 </p>
<ul>
<li>
<p>任务分发器会生成大量可以并行计算的任务；</p>
</li>
<li>
<p>有一组worker会处理这些任务；</p>
</li>
<li>
<p>结果收集器会在末端接收所有worker的处理结果，进行汇总。</p>
</li>
</ul>
<p><img alt="" src="https://upload-images.jianshu.io/upload_images/1752522-b407a578492a4ce5.png?imageMogr2/auto-orient/strip|imageView2/2/w/415/format/webp" /></p>
<h6 id="mqtt_1">MQTT</h6>
<pre><code class="language-python">MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的“轻量级”通讯协议，该协议构建于TCP/IP协议上，由IBM在1999年发布。

MQTT最大优点在于，用极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。

作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。
</code></pre>
<p>MQTT协议特点</p>
<pre><code class="language-python">MQTT是一个基于客户端-服务器的消息发布/订阅传输协议。
MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。
MQTT 与 HTTP 一样，MQTT 运行在传输控制协议/互联网协议 (TCP/IP) 堆栈之上。
MQTT使用的发布/订阅消息模式，它提供了一对多的消息分发机制，从而实现与应用程序的解耦。这是一种消息传递模式，消息不是直接从发送器发送到接收器（即点对点），而是由MQTT server（或称为 MQTT Broker）分发的。
MQTT 服务器是发布-订阅架构的核心。
</code></pre>
<p>QoS（Quality of Service levels）</p>
<pre><code class="language-python">QoS 0 这一级别会发生消息丢失或重复，消息发布依赖于底层TCP/IP网络。即：&lt;=1
QoS 1 承诺消息将至少传送一次给订阅者。
QoS 2 使用 QoS 2，我们保证消息仅传送到目的地一次。为此，带有唯一消息 ID 的消息会存储两次，首先来自发送者，然后是接收者。QoS 级别 2 在网络中具有最高的开销，因为在发送方和接收方之间需要两个流。
</code></pre>
<p>MQTT 数据包结构</p>
<pre><code class="language-python">固定头（Fixed header），存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识；
可变头（Variable header），存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容；
消息体（Payload），存在于部分MQTT数据包中，表示客户端收到的具体内容；
</code></pre>
<p><img alt="" src="https://pic3.zhimg.com/80/v2-861c089bea9570876bb13a031e6c3902_1440w.jpg" /></p>
<p>协议版本3定义了14种 MQTT 报文，用于建立/断开连接、发布消息、订阅消息和维护连接。固定报头的第一字节的4-7位的值指定了报文类型，其取值如下表。</p>
<table>
<thead>
<tr>
<th><strong>报文类型</strong></th>
<th><strong>值</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>CONNECT</td>
<td>1</td>
<td>客户端向代理发起连接请求</td>
</tr>
<tr>
<td>CONNACK</td>
<td>2</td>
<td>连接确认</td>
</tr>
<tr>
<td>PUBLISH</td>
<td>3</td>
<td>发布消息</td>
</tr>
<tr>
<td>PUBACK</td>
<td>4</td>
<td>发布确认</td>
</tr>
<tr>
<td>PUBREC</td>
<td>5</td>
<td>发布收到（QoS2）</td>
</tr>
<tr>
<td>PUBREL</td>
<td>6</td>
<td>发布释放（QoS2）</td>
</tr>
<tr>
<td>PUBCOMP</td>
<td>7</td>
<td>发布完成（QoS2）</td>
</tr>
<tr>
<td>SUBSCRIBE</td>
<td>8</td>
<td>客户端向代理发起订阅请求</td>
</tr>
<tr>
<td>SUBACK</td>
<td>9</td>
<td>订阅确认</td>
</tr>
<tr>
<td>UNSUBSCRIBE</td>
<td>10</td>
<td>取消订阅</td>
</tr>
<tr>
<td>UNSUBACK</td>
<td>11</td>
<td>取消订阅确认</td>
</tr>
<tr>
<td>PINGREQ</td>
<td>12</td>
<td>PING请求</td>
</tr>
<tr>
<td>PINGRESP</td>
<td>13</td>
<td>PING响应</td>
</tr>
<tr>
<td>DISCONNECT</td>
<td>14</td>
<td>断开连接</td>
</tr>
</tbody>
</table>
<h4 id="3mqtt">3.MQTT模型</h4>
<p><img alt="" src="https://tse4-mm.cn.bing.net/th/id/OIP-C.7MwXy5N4rx4mAxZ2KZrwJQHaEM?pid=ImgDet&amp;rs=1" /></p>
<h4 id="4python-mqtt">4.python MQTT使用</h4>
<p>目前使用的是emqx 加 paho.mqtt</p>
<p>emqx官网：https://www.emqx.io/zh/downloads#broker</p>
<p>用emqx在windows上建立服务器，先下载适合的安装包，解压后进入bin目录，在cmd中使用命令 emqx.cmd start启动服务器，关闭服务器的命令是emqx.cmd stop。</p>
<p>启动服务器后，浏览器打开<code>http://127.0.0.1:18083</code>，使用默认管理账号<code>admin/public</code>即可登录查看，在设置里还能改成中文界面，很方便。</p>
<p>使用python 连接mqtt服务器，使用的模块是paho-mqtt,代码如下</p>
<pre><code class="language-python">
# 为了能在外部脚本中调用Django ORM模型，必须配置脚本环境变量，将脚本注册到Django的环境变量中
import os, sys,json
import django
import requests
# 第一个参数固定，第二个参数是工程名称.settings
os.environ.setdefault('DJANGO_SETTING_MODULE', 'djangoProject.settings')
django.setup()

# 引入mqtt包
import paho.mqtt.client as mqtt
# 使用独立线程运行
from threading import Thread
from .app01 import models
import time
import json
from .app01.serializers import AiBingSerializer

# 建立mqtt连接
def on_connect(client, userdata, flag, rc):
    print(&quot;Connect with the result code &quot; + str(rc))
    client.subscribe('test', qos=0)

# 接收、处理mqtt消息
def on_message(client, userdata, msg):
    out = str(msg.payload.decode('utf-8'))
    print(out)
    out = json.loads(out)
    # 收到消息后执行任务
    if msg.topic:
        try:
            aibing = models.AiBing.objects.get(Code=out,IsDelete=False)
            print(aibing.IsUerd)
            if not aibing.IsUerd:
                res = 1
                res2 = json.dumps(res)
                client.publish('test', payload=res2, qos=1)
                models.AiBing.objects.filter(Code=out, IsDelete=False).update(IsUerd=True)
                return
            else:
                res = 0
                res2 = json.dumps(res)
                client.publish('test', payload=res2, qos=0)
                return
        except:
            print('不存在')


# mqtt客户端启动函数
def mqttfunction():
    global client
    # 使用loop_start 可以避免阻塞Django进程，使用loop_forever()可能会阻塞系统进程
    # client.loop_start()
    # client.loop_forever() 有掉线重连功能
    client.loop_forever(retry_first_connection=True)

client = mqtt.Client(client_id=&quot;test&quot;, clean_session=False)

# 启动函数
def mqtt_run():
    client.on_connect = on_connect
    client.on_message = on_message
    # 绑定 MQTT 服务器地址
    broker = '127.0.0.1'
    # MQTT服务器的端口号
    client.connect(broker, 1883, 600)
    # 启动
    mqttthread = Thread(target=mqttfunction)
    mqttthread.start()

# 启动 MQTT
# mqtt_run()

if __name__ == &quot;__main__&quot;:
    mqtt_run()
</code></pre>
<h4 id="6">6 源码解析</h4>
<pre><code class="language-python">paho-mqtt 包含这些文件
clinet.py
matchar.py
packetty.py
properties.py
publish.py
reasoncodes.py
subscribe.py
subscribeoptions.py
先看client文件
包含五个obj五个fanc
obj：Client，MQTTMessage,MQTTMessageInfo,WebsocketConnectionError,WebscoketWrapper
fanc:_socketpair_compat(),base62(),connack_string(connack_code),error_string,topic_matches_sub()

Client中常用的方法：
client.loop:默认无限阻塞循环，不推荐直接使用。成功时返回MQTT_ERR_SUCCESS。出错返回值&gt;0,会引发值错误。 具有 QoS&gt;0 的消息。

Client.loop_forever:无限阻塞循环，已在程序中循环运行客户端，默认会重新连接。retry_first_connection:如果第一次连接尝试失败时重试。

Client.loop_start:线程客户端，调用一次启动一个新线程

Client.loop_stop:与上对应，调用一次停止start启动的线程客户端

Client.on_message:客户端收到有关主题每条消息都会调用，用于特定主题过滤器

Client.publish:（参数：self, topic, payload=None, qos=0, retain=False, properties=None）
topic：发布消息的主题
payload：默认为None 实际发布的消息，不能为int和float类型，应为str类型
qos:服务级别
retain：设置为True，则设置为最后一个保存的主题消息
properties：mqtt5.0的属性
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../.." class="btn btn-neutral float-left" title="Welcome to MkDocs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../.." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
